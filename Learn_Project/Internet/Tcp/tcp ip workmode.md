TCP/IP 协议

TCP/IP分层     对应OSI分层          TCP/IP协议族
---------------------------------------------------------------------
应用层          应用层              POP3        |      | DHCP  TFTP
                                   FTP  HTTP   |      | SNMP  DNS
                表示层              Telnet SMTP | NFS | 
---------------------------------------------------------------------
传输层          会话层
                                   TCP       |       |  UDP
                传输层
---------------------------------------------------------------------
网际层           网络层             IP  ICMP IGMP ARP  RARP
---------------------------------------------------------------------
网络接口层      数据链路层           CSMA/CD      TokingRing
                物理层


1. POP3 (Post Office Protocol-Version 3, 邮局协议版本3)

TCP/IP协议族一员
由RFC 1939 中定义
本协议主要用于支持使用客户端远程管理在服务器上的电子邮件 
提供 SSL加密的POP3协议被称为POP3S

POP的改进协议POP3
POP协议支持离线邮件处理，这种离线访问是一种存储转发服务，一般POP协议在邮件发送到客户端后会将服务端上的邮件删除，但是支持POP3协议的服务器大都可以 只下载邮件，而不删除服务端的邮件。 

协议特性
POP3 协议默认端口：110
POP3 协议默认传输协议：TCP
POP3 协议适用的构架结构：C/S
POP3 协议的访问模式：离线访问

命令响应
客户端向服务器发送命令并等待响应，命令采用命令行的形式，用ASCLL码表示，服务器响应由一个单独或多个命令行组成，响应第一行由ASCLL文本+OK或-ERR表示相应的操作状态是成功或失败。

三种状态：认证、处理、更新。
建立连接时客户端向服务端发送身份认证，由服务器确认后转入处理状态，在列出未读邮件等相应操作后向客户端发出quit命令，退出处理状态进入更新状态，开始下载未读邮件到客户端，最后返回认证状态确认身份后断开与服务器的连接。

大多数POP协议的客户端采用明文发送ASCLL码来认证用户名和密码，在POP3中得到改进，采用了APOP的认证方法，认证口令在发送前进行加密，在客户端与服务器发送第一次建立连接时服务器向客户端发送一个ASCLL码文本问候，对每一个客户机都是唯一的，内容一般是当地时间之类的然后客户端把密码口令附加在接收的问候后面，计算出新的字符串的MD5单出函数值的消息数据，最后客户端将用户名和MD5加密后的消息摘要作为APOP命令的参数发送到服务端，但是大多数windows上的邮件客户端不支持APOP协议，qpopper支持。

POP3命令码
命令                描述
USER[username]      处理用户名
PASS[passwaord]     处理用户密码
APOP[Name, Diges]   认可Digest是MD5消息摘要
STAT                处理请求服务器发回关于邮箱的统计资料，如邮件总数和总字节数
UIDL[Msg#]          处理返回邮件的唯一标识符，POP3会话的每个标识符都是唯一的
LIST[Msg#]          处理返回邮件数量和每个邮件的大小
RETR[Msg#]          处理返回由参数标识的邮件的全部文本
DETR[Msg#]          处理服务器将由参数标识的邮件标记为删除，由quit命令执行
RSET                处理服务器将重置所有标记为删除的邮件，用于撤销DELE命令
TOP[Msg#]           处理服务器将返回由参数标识的邮件前n行内容，n 必须是正整数
NOOP                处理服务器返回一个肯定的相应
QUIT                终止会话

--------------------------------------------------------------------------
2. DHCP (动态主机配置协议,Dynamic Host Configuration Protocol)
DHCP 是一种局域网协议，指由服务器控制一段IP地址范围，客户机登录服务器是可以自动获得服务器分配的IP地址和子网掩码，在Windows默认情况下DHCP属于windows server的一个服务组件，不会被系统自动安装，需要管理员手动配置。

通常被用于大型的局域网络中，进行集中的管理、IP分配，提升地址的使用率
DHCP协议采用 客户端/服务器模型，主机地址的动态分配任务由网络主机驱动。
当DHCP服务器收到来自网络主机申请地址的信息时，才会向网络主机发送相关的地址配置等信息

DHCP具有以下功能
    1.保证任何IP地址在同一时刻只能由一台DHCP客户机所使用
    2.DHCP应当可以给用户分配永久固定的ip地址
    3.DHCP应当可以同用其他方法获得ip地址的主机共存
    4.DHCP服务器应当向现有的BOOTP客户端提供服务

DHCP有三种分配ip地址的机制
    1.自动分配(Automatic Allocation)
        DHCP服务器为主机指定一个永久性的IP地址，在主机从服务器第一次成功获取到IP地址后可以永久性的使用该地址
    2.动态分配方式(Dynamic Allocation)
        DHCP服务器给主机指定一个具有时间限制的IP地址，当时间到期或该主机明确表示放弃该地址时，该IP地址可以被其他主机使用
    3.手工分配(Manual Allocation)
        客户端的IP地址是由网络管理员指定的，DHCP服务器只负责将IP地址告诉客户端主机
三种方式中只有动态分配可以重复使用客户端不在需要的地址

DHCP消息的格式是基于BOOTP(Bootstrap Protocol) 消息格式的，所以要求设备具有
BOOTP中继代理的功能，并能够与BOOTP客户端和DHCP服务器实现交互，BOOTP中继代理的功
能使得没必要每一个物理网络都部署一个DHCP服务器。
RFC 951和RFC 1542对BOOTP协议进行了详细的描述

DHCP封包在传输层(Transport Layer)是采用UDP协议，当Client传送封包给Server是采用的是UDP 68 port，从Server传送给Client则是用UDP 67 port

DHCP 封包格式：
op(1)   |   htype(1)    |   hlen(1)  |  hops(1)
                       xid(4)
        secs(2)         |            flags(2)
                       ciaddr(4)
                       yiaddr(4)
                       siaddr(4)
                       giaddr(4)
                       chaddr(4)
                       sname(64)
                       file(128) 
                       options(variable)
各个字段定义：
op:
若是client给server分包设为1，反之2

htype:
硬件类别，Ethernet为6

hlent：
若封包需经过router传送，每站加1，若在同一网内，为0

transaction ID：
DHCP REQUEST时产生的数值，作为DHCPREPLY时的依据

seconds：
client端启动的时间(秒)

flags:
从0到15共16bits，左一为1时表示server将以广播的方式传送封包给client，其余尚未使用

ciaddr：
要是client端想继续使用之前取得的地址则列在这里

yiaddr：
从server送回到client之DHCP OFFER 与 DHCPACK封包中，此栏填写分配给client的IP地址

siaddr：
若client需要透过网络开机，从server送出DHCP OFFER、DHCPACK、DHCPNACK封包中，此懒填写开机程序代码所在server地址

giaddr：
若需要跨网进行DHCP发放，此栏为relay agent的地址，否则为0

chaddr：
client硬件地址

sname：
server名字字符串，已0x00结尾

file：
若client需要透过网络开机， 此栏给出开机程序名称，稍后以TFTP传送

工作原理：DHCP协议采用UDP作为传输协议，主机发送请求到DHCP服务器的67号端口，DHCP服务器应答消息发送到主机68号端口

DHCP设备
DHCP以C/S模式运行，使用DHCP的设备为client，提供DHCP服务的为server

3. TFTP (Trivial File Transfer Protocol 简单的文件传输协议)
是TCP/IP 协议族中用来在客户机与服务器之间进行简单文件传输的协议，提供不复杂开销不大的文件传输服务。

端口号为 69
在传输层使用 UDP协议(有些的TFTP协议 也可以基于其他的 传输协议完成)
主要是进行小文件传输

TFTP协议不具有通常的 FTP 协议的许多功能，它只能从文件服务器上获得或写入文件，不能列出列表，不进行认证，传输8为数据，传输中有三种模式：
netascii(这是8位ASCLL码形式), 
另一种是 octet(8位源数据类型),
最后一种是mail已经不再支持，它将返回的数据直接返回给用户而不是保存为文件。

概括：
    任何传输起自一个读取或写入文件的请求，这个请求也是连接请求.如果服务器批
准请求, 则服务器打开连接,数据以定长512字节传输.每个数据包包括一块数据,服务器发出下一个数据包以前必须得到客户端对上一个数据包的确认. 如果一个数据包大小小于512字节,则表示传输结束. 如果数据包在传输过程中丢失,发出方会在超时后重新传输最后一个未被确认的数据包.通信的双方都是数据的发出者与接受者,一方传输数据接收应答,另一方发出应答接收数据. 大部分的错误会导致连接中断,错误由一个错误的数据包引起.这个包不会被确认,也不会被重新发送,因此另一方无法接收到. 如果错误包丢失,则使用超时机制. 错误主要由下面三种情况引起:
1 不能满足要求,收到的数据包内容错误,而这种错误不能由延时或重发解释
2 对需要资源的访问丢失(硬盘满).
3 TFTP 只在一种情况下不中断连接,这种情况是源端口不正确,在这种情况下,指示错误的包会被发送到原机.
这个协议的限制很多,这些都是为了实现起来比较方便而进行的.

特点:
    因为TFTP使用UDP,而UDP使用IP协议, ip协议还可以使用其他本地通信方法.因此一个TFTP包会出现以下几段: 
    1. 本地媒介头
    2. IP头
    3. 数据包头
    4. TFTP头
    5. TFTP数据
    TFTP在IP头中不指定任何数据,但是它使用UDP中的源和目标端口以及包长度域.由TFTP使用的包标记(TID)在这里被用作端口,因此TID必须介于0-65535之间.
    TFTP头中包括两个字节的操作码,这个码指出了包的类型:
     local medium | internet | datagram | TFTP

TFTP 的优点:
1. 可用于UDP环境,比如需要将程序或多个文件同时向许多机器下载时就需要用到TFTP协议
2. 占用内存小, 对于较小计算机或特殊用途机器很重要,这些设备不需要硬盘,只需要固化了TFTP,UDP和IP的小容量只读存储器即可,这种方法增加了灵活性也减少了开销.
